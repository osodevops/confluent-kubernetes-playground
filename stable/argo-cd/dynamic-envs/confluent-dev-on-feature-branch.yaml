apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: guestbook
spec:
  generators:
    - scmProvider:
        requeueAfterSeconds: 60
        github:
          allBranches: true
          organization: osodevops
          tokenRef:
            secretName: github-token
            key: token
        cloneProtocol: https
        filters:
          - repositoryMatch: ^argocd-confluent-deployments
            branchMatch: ^feature
  template:
    metadata:
      name: "{{ repository }}-{{ branchNormalized }}"
    spec:
      project: "default"
      source:
        repoURL: "{{ url }}"
        targetRevision: HEAD
        path: kustomize/dev
      destination:
        server: https://kubernetes.default.svc
        namespace: "dev-{{ branchNormalized }}"
      syncPolicy:
        syncOptions:
          - CreateNamespace=true
        automated:
          prune: true
          selfHeal: true
        retry:
          limit: 3 # number of failed sync attempt retries; unlimited number of attempts if less than 0
          backoff:
            duration: 10s # the amount to back off. Default unit is seconds, but could also be a duration (e.g. "2m", "1h")
            factor: 2 # a factor to multiply the base duration after each failed retry
            maxDuration: 3m # the maximum amount of time allowed for the backoff strategy