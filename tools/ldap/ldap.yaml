apiVersion: v1
kind: Pod
metadata:
  name: ldap
  namespace: tools
  labels:
    role: ldap
    app: ldap
spec:
  containers:
    - name: ldap
      args:
      - --copy-service
      - --loglevel=debug
      image: osixia/openldap:1.4.0
      ports:
        - name: ldap
          containerPort: 389
        - name: ldaps
          containerPort: 636
      livenessProbe:
        tcpSocket:
          port: 389
        initialDelaySeconds: 15
        periodSeconds: 20
      env:
        - name: LDAP_ORGANISATION
          value: "Test Inc"
        - name: LDAP_DOMAIN
          value: "test.com"
        - name: LDAP_BASE_DN
          value: "dc=test,dc=com"
        - name: LDAP_ADMIN_PASSWORD
          value: "confluentrox"
        - name: LDAP_CONFIG_PASSWORD
          value: "confluentconfigrox"
        - name: KEEP_EXISTING_CONFIG
          value: "False"
        - name: LDAP_REMOVE_CONFIG_AFTER_SETUP
          value: "True"
        - name: LDAP_READONLY_USER
          value: "True"
        - name: LDAP_READONLY_USER_USERNAME
          value: "mds"
        - name: LDAP_READONLY_USER_PASSWORD
          value: "Developer!"
        - name: LDAP_TLS
          value: "False"
      volumeMounts:
      - mountPath: /container/service/slapd/assets/config/bootstrap/ldif/custom
        name: customldif
      - mountPath: /var/lib/ldap
        name: ldap-data
      - mountPath: /etc/ldap/slapd.d
        name: ldap-config
  volumes:
    - name: customldif
      configMap:
        defaultMode: 420
        name: ldap-ldifs
    - name: ldap-data
      emptyDir: {}
    - name: ldap-config
      emptyDir: {}

  restartPolicy: Always
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ldap-ldifs
  namespace: tools
data:
  kafka.ldif: |-
    dn: cn=kafka,dc=test,dc=com
    userPassword: kafka-secret
    description: kafka user
    objectClass: simpleSecurityObject
    objectClass: organizationalRole
    cn: kafka
  erp.ldif: |-
    dn: cn=erp,dc=test,dc=com
    userPassword: erp-secret
    description: erp user
    objectClass: simpleSecurityObject
    objectClass: organizationalRole
    cn: erp
  sr.ldif: |-
    dn: cn=sr,dc=test,dc=com
    userPassword: sr-secret
    description: schema registry user
    objectClass: simpleSecurityObject
    objectClass: organizationalRole
    cn: sr
  c3.ldif: |-
    dn: cn=c3,dc=test,dc=com
    userPassword: c3-secret
    description: control center user
    objectClass: simpleSecurityObject
    objectClass: organizationalRole
    cn: c3
  ksql.ldif: |-
    dn: cn=ksql,dc=test,dc=com
    userPassword: ksql-secret
    description: ksql user
    objectClass: simpleSecurityObject
    objectClass: organizationalRole
    cn: ksql
  connect.ldif: |-
    dn: cn=connect,dc=test,dc=com
    userPassword: connect-secret
    description: connect user
    objectClass: simpleSecurityObject
    objectClass: organizationalRole
    cn: connect
  replicator.ldif: |-
    dn: cn=replicator,dc=test,dc=com
    userPassword: replicator-secret
    description: replicator user
    objectClass: simpleSecurityObject
    objectClass: organizationalRole
    cn: replicator
  c3-test.ldif: |-
    dn: cn=testadmin,dc=test,dc=com
    userPassword: testadmin
    description: testadmin user
    objectClass: simpleSecurityObject
    objectClass: organizationalRole
    cn: testadmin
---
apiVersion: v1
kind: Service
metadata:
  name: ldap
  labels:
    app: ldap
  namespace: tools
spec:
  ports:
    - port: 389
      name: ldap
    - port: 636
      name: ldaps
  clusterIP: None
  selector:
    app: ldap



